{% extends "Detector/base.html" %}
{% block content %}
<div class="container">
    <div class="d-flex mb-5 justify-content-center" style="height: 35vw">
        <!-- Column Selection Form -->
        <div class="filters-box" style="height: 70%; width: 20%; margin: 5%; padding: 1%; border: 1px solid #ccc; background: #00000005;">
            <form method="post">
                {% csrf_token %}
                <input type="hidden" name="action" value="select_column">
                <div class="form-group"  style="font-size: 0.95rem;">
                    <label for="columns">Selectează Coloane:</label><br>
                    {% for column in column_options %}
                        <input type="checkbox" name="columns" class="m-1" style="accent-color: #923846;" value="{{ column }}" {% if column in selected_columns %}checked{% endif %}> {{ column }}<br>
                    {% endfor %}
                </div>
                <button type="submit" class="btn btn-django mt-3" style="width: 100%">Updatează</button>
            </form>
        </div>
        <div class="container-fluid" style="border: 1px solid #ccc; background: #00000005;">
            <!-- Tab panes -->
            <div class="tab-content mt-2 mb-3" id="nav-tabContent" style="height:87.5%">
                <div class="tab-pane fade show active" id="nav-procentaje" role="tabpanel" aria-labelledby="nav-procentaje-tab">
                    <!-- Display the column chart -->
                    <div class="d-flex justify-content-center">
                        <img src="data:image/png;base64,{{ column_chart_base64 }}" alt="Column Chart" class="img-fluid">
                    </div>
                </div>
                <div class="tab-pane fade" id="nav-rezumat" role="tabpanel" aria-labelledby="nav-rezumat-tab">
                    <div class="justify-content-center" style="font-size: 0.8rem; display: flex; flex-wrap: wrap;">
                        {% for detail in patient_details %}
                        <div>
                            <table class="table table-bordered">
                                <tbody>
                                    <tr>
                                        <th>Dată: {{ detail.date }}</th>
                                    </tr>
                                    <tr>
                                        <th>Risc: {{ detail.risk }}</th>
                                    </tr>
                                    {% for reason in detail.reasons %}
                                    <tr>
                                        <th>{{reason.0}} : {{reason.1}}</th>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% endfor %}
                    </div>
                </div>                                                                                                                                                                                                                          
            </div>
            <!-- Nav tabs -->
            <nav>
                <div class="nav justify-content-center" id="nav-tab" role="tablist" style="font-size: 0.7rem;">
                    <button class="btn btn-django shadow-none ms-2" id="nav-procentaje-tab" data-bs-toggle="tab" data-bs-target="#nav-procentaje" type="button" role="tab" aria-controls="nav-procentaje" aria-selected="true">Procentaje Pacient</button>
                    <button class="btn btn-django shadow-none ms-2" id="nav-rezumat-tab" data-bs-toggle="tab" data-bs-target="#nav-rezumat" type="button" role="tab" aria-controls="nav-rezumat" aria-selected="false">Rezumat Pacient</button>
                </div>
            </nav>
        </div>
    </div>
    <!-- Patient Table -->
    <table class="table table-striped table-bordered bg-light">
        <thead class="thead-light">
            <tr>
                <th class="fw-bold" style="width: 6%; font-size: 0.75em;">NSS</th>
                <th class="fw-bold" style="width: 8%; font-size: 0.75em;">Prenume</th>
                <th class="fw-bold" style="width: 8%; font-size: 0.75em;">Nume</th>
                <th class="fw-bold" style="width: 12%; font-size: 0.75em;">Email</th>
                <th class="fw-bold" style="width: 4%; font-size: 0.75em;">Vârstă</th>
                <th class="fw-bold" style="width: 4%; font-size: 0.75em;">Sex</th>
                <th class="fw-bold" style="width: 4%; font-size: 0.75em;">Înălțime</th>
                <th class="fw-bold" style="width: 4%; font-size: 0.75em;">Greutate</th>
                <th class="fw-bold" style="width: 4%; font-size: 0.75em;">TAS</th>
                <th class="fw-bold" style="width: 4%; font-size: 0.75em;">TAD</th>
                <th class="fw-bold" style="width: 6%; font-size: 0.75em;">Colesterol</th>
                <th class="fw-bold" style="width: 6%; font-size: 0.75em;">Glucoză</th>
                <th class="fw-bold" style="width: 4%; font-size: 0.75em;">Fumător</th>
                <th class="fw-bold" style="width: 4%; font-size: 0.75em;">Băutor</th>
                <th class="fw-bold" style="width: 4%; font-size: 0.75em;">Activitate</th>
                <th class="fw-bold" style="width: 4%; font-size: 0.75em;">Risc Boală</th>
                <th class="fw-bold" style="width: 4%; font-size: 0.75em;">Dată Adăugare</th>
            </tr>
        </thead>
        <tbody>
            {% for patient in patients %}
            <tr>
                <td style="width: 6%; font-size: 0.75em;">{{ patient.NSS }}</td>
                <td style="width: 8%; font-size: 0.75em;">{{ patient.Prenume }}</td>
                <td style="width: 8%; font-size: 0.75em;">{{ patient.Nume }}</td>
                <td style="width: 12%; font-size: 0.75em;">{{ patient.Email }}</td>
                <td style="width: 4%; font-size: 0.75em;">{{ patient.Vârstă }}</td>
                <td style="width: 4%; font-size: 0.75em;">{{ patient.Sex }}</td>
                <td style="width: 4%; font-size: 0.75em;">{{ patient.Înălțime }}</td>
                <td style="width: 4%; font-size: 0.75em;">{{ patient.Greutate }}</td>
                <td style="width: 4%; font-size: 0.75em;">{{ patient.TAS }}</td>
                <td style="width: 4%; font-size: 0.75em;">{{ patient.TAD }}</td>
                <td style="width: 6%; font-size: 0.75em;">{{ patient.Colesterol }}</td>
                <td style="width: 6%; font-size: 0.75em;">{{ patient.Glucoză }}</td>
                <td style="width: 4%; font-size: 0.75em;">{{ patient.Fumător }}</td>
                <td style="width: 4%; font-size: 0.75em;">{{ patient.Băutor }}</td>
                <td style="width: 4%; font-size: 0.75em;">{{ patient.Activitate }}</td>
                <td style="width: 4%; font-size: 0.75em;">{{ patient.Risc_Boală}}</td>
                <td style="width: 8%; font-size: 0.75em;">{{ patient.Dată_Adăugare|date:"d/m/Y, H:i" }}</td>
                <td style="width: 6%; font-size: 0.75em;">
                    <!-- Trigger Delete Modal -->
                    <button type="button" class="btn btn-django btn-sm" data-bs-toggle="modal" data-bs-target="#deleteModal{{ patient.id }}">Ștergere</button>
                </td>
                </tr>
                
                <!-- Delete Modal -->
                <div class="modal fade" id="deleteModal{{ patient.id }}" tabindex="-1" aria-labelledby="deleteModalLabel{{ patient.id }}" aria-hidden="true">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="deleteModalLabel{{ patient.id }}">Confirmare Ștergere</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Închide"></button>
                            </div>
                            <div class="modal-body">
                                <p>Sigur dorești să elimini această intrare?</p>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Anulează</button>
                                <form method="post" style="display:inline;">
                                    {% csrf_token %}
                                    <input type="hidden" name="action" value="delete">
                                    <input type="hidden" name="patientId" value="{{ patient.id }}">
                                    <button type="submit" class="btn btn-django">Șterge</button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endblock %}